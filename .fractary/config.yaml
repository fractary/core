version: "2.0"

# ============================================================================
# Work Tracking Configuration
# Supports: GitHub Issues, Jira, Linear
# ============================================================================
work:
  # Active work tracking platform
  active_handler: github  # Options: github | jira | linear

  # Platform-specific handlers
  handlers:
    # GitHub Issues configuration
    github:
      owner: fractary
      repo: core
      token: ${GITHUB_TOKEN}
      api_url: https://api.github.com

      # Issue classification by labels
      classification:
        feature: [feature, enhancement, story, user-story]
        bug: [bug, fix, defect, error]
        chore: [chore, maintenance, docs, documentation, test, refactor]
        patch: [hotfix, patch, urgent, critical, security]

      # State mapping
      states:
        open: OPEN
        in_progress: OPEN
        in_review: OPEN
        done: CLOSED
        closed: CLOSED

      # Label configuration
      labels:
        prefix: faber-
        in_progress: in-progress
        in_review: in-review
        completed: completed
        error: faber-error

  # Default behaviors
  defaults:
    auto_assign: false
    auto_label: true
    close_on_merge: true
    comment_on_state_change: true
    link_pr_to_issue: true

  # Webhook/automation hooks
  hooks:
    auto_comment:
      enabled: true
      throttle_minutes: 0
      async: false
      detailed_analysis: false

  # Advanced settings
  advanced:
    retry:
      enabled: true
      max_attempts: 3
      backoff_seconds: 5
    rate_limiting:
      enabled: true
      requests_per_minute: 60
    caching:
      enabled: false
      ttl_seconds: 300

# ============================================================================
# Repository Management Configuration
# Supports: GitHub, GitLab, Bitbucket
# ============================================================================
repo:
  # Active repository platform
  active_handler: github  # Options: github | gitlab | bitbucket

  # Platform-specific handlers
  handlers:
    github:
      token: ${GITHUB_TOKEN}
      api_url: https://api.github.com

  # Default repository settings
  defaults:
    default_branch: main
    protected_branches: [main, master, production, staging]

    # Branch naming convention
    branch_naming:
      pattern: "{prefix}/{issue_id}-{slug}"
      allowed_prefixes: [feat, fix, chore, hotfix, docs, test, refactor, style, perf]

    # Commit settings
    commit_format: faber
    require_signed_commits: false

    # Merge settings
    merge_strategy: no-ff
    auto_delete_merged_branches: false

    # Remote settings
    remote:
      name: origin
      auto_set_upstream: true

    # Sync strategies
    push_sync_strategy: auto-merge
    pull_sync_strategy: auto-merge-prefer-remote

    # Pull request settings
    pr:
      template: standard
      require_work_id: true
      auto_link_issues: true
      ci_polling:
        enabled: true
        interval_seconds: 60
        timeout_seconds: 900
        initial_delay_seconds: 10

    # Cleanup settings
    cleanup:
      inactive_threshold_days: 30
      auto_cleanup_merged: false
      exclude_patterns: [release/*, hotfix/*]

    # Tag settings
    tags:
      require_signed_tags: false
      auto_push_tags: false

  # FABER workflow integration
  faber_integration:
    enabled: true
    branch_creation:
      auto_create: true
      use_work_id: true
    commit_metadata:
      include_author_context: true
      include_phase: true
      include_work_id: true
    pr_creation:
      auto_create: true
      include_metadata: true
      draft_until_approved: false

  # Automation hooks
  hooks:
    auto_commit:
      enabled: true
      throttle_minutes: 0
    unified:
      enabled: false
      run_commit: true
      run_comment: true

  # Platform-specific overrides
  platform_specific:
    github:
      use_gh_cli: true
      pr_checks:
        require_ci_pass: true
        require_reviews: 1

# ============================================================================
# Logs Management Configuration
# Session logging, archiving, and retention
# ============================================================================
logs:
  schema_version: "2.0"

  # Storage configuration
  storage:
    local_path: .fractary/logs
    cloud_archive_path: archive/logs/{year}/{month}/{issue_number}
    cloud_logs_path: archive/logs/claude-logs/{year}
    cloud_summaries_path: archive/logs/claude-summaries/{year}
    archive_index_file: archive-index.json

  # Retention policies
  retention:
    # Default retention policy
    default:
      local_days: 30
      cloud_days: forever
      priority: medium
      auto_archive: true
      cleanup_after_archive: true

    # Per-log-type retention policies
    paths:
      - pattern: sessions/*
        log_type: session
        local_days: 7
        cloud_days: forever
        priority: high
        auto_archive: true
        cleanup_after_archive: false

        # Exceptions to retention rules
        retention_exceptions:
          keep_if_linked_to_open_issue: true
          keep_if_referenced_in_docs: true
          keep_recent_n: 10

        # Archive triggers
        archive_triggers:
          age_days: 7
          size_mb: null
          status: [stopped, error]

        # Validation before archive
        validation:
          require_summary: true
          require_redaction_check: true
          warn_if_no_decisions: true

        # Compression settings
        compression:
          enabled: true
          format: gzip
          threshold_mb: 1

        # Metadata
        metadata:
          description: Claude Code conversation session logs
          typical_size_mb: 1
          typical_duration_minutes: 30
          value: High - contains decisions, context, and implementation details

      - pattern: builds/*
        log_type: build
        local_days: 14
        cloud_days: 90
        priority: medium

      - pattern: deployments/*
        log_type: deployment
        local_days: 30
        cloud_days: forever
        priority: high

  # Automatic backup settings
  auto_backup:
    enabled: true
    trigger_on_init: true
    trigger_on_session_start: true
    backup_older_than_days: 7
    generate_summaries: true

  # Summarization settings
  summarization:
    enabled: true
    auto_generate_on_archive: true
    model: claude-sonnet-4-5-20250929
    store_with_logs: false
    separate_paths: true
    format: markdown

  # Archive settings
  archive:
    auto_archive_on:
      work_complete: true
      issue_close: true
      manual_trigger: true
    compression:
      enabled: true
      format: gzip
      threshold_mb: 1
    post_archive:
      update_archive_index: true
      comment_on_issue: true
      remove_from_local: true
      keep_index: true

  # Session logging configuration
  session_logging:
    enabled: true
    auto_capture: true
    format: markdown
    include_timestamps: true
    redact_sensitive: true
    auto_name_by_issue: true
    model_name: claude-sonnet-4-5-20250929

    # Sensitive data redaction patterns
    redaction_patterns:
      api_keys: true
      jwt_tokens: true
      passwords: true
      credit_cards: true
      email_addresses: false

  # Search configuration
  search:
    index_local: true
    search_cloud: true
    max_results: 100
    default_context_lines: 3

  # Integration with other plugins
  integration:
    github:
      enabled: true
      comment_on_capture: false
      comment_on_archive: true
    faber:
      auto_capture: true
      auto_archive_on_complete: true

  # Documentation integration
  docs_integration:
    enabled: true
    copy_summary_to_docs: true
    docs_path: docs/conversations
    update_index: true
    index_file: docs/conversations/README.md
    summary_filename_pattern: "{date}-{issue_number}-{slug}.md"
    index_format: table
    max_index_entries: 50

# ============================================================================
# File Storage Configuration
# Supports: Local, S3, R2, GCS, Google Drive
# ============================================================================
file:
  schema_version: "2.0"

  # Named sources for different artifact types
  sources:
    specs:
      type: s3
      bucket: core-files              # {project-name}-files
      prefix: specs/
      region: us-east-1
      local:
        base_path: .fractary/specs
      push:
        compress: false
        keep_local: true
      auth:
        profile: default

    logs:
      type: s3
      bucket: core-files              # Same bucket, different prefix
      prefix: logs/
      region: us-east-1
      local:
        base_path: .fractary/logs
      push:
        compress: true                # Enable compression for logs
        keep_local: true
      auth:
        profile: default

# ============================================================================
# Specification Management Configuration
# Feature specs linked to work items
# ============================================================================
spec:
  schema_version: "1.0"

  # Storage paths
  storage:
    local_path: .fractary/specs
    cloud_archive_path: archive/specs/{year}/{spec_id}.md

    # Archive index (two-tier: local cache + cloud backup)
    archive_index:
      local_cache: .fractary/specs/archive-index.json
      cloud_backup: archive/specs/.archive-index.json

  # Spec naming conventions
  naming:
    # Issue-linked specifications
    issue_specs:
      prefix: WORK
      digits: 5
      phase_format: numeric
      phase_separator: "-"

    # Standalone specifications
    standalone_specs:
      prefix: SPEC
      digits: 4
      auto_increment: true
      start_from: null

  # Archive lifecycle
  archive:
    strategy: lifecycle

    # When to archive
    auto_archive_on:
      issue_close: true
      pr_merge: true
      faber_release: true

    # Pre-archive checks
    pre_archive:
      check_docs_updated: warn
      prompt_user: true
      require_validation: false

    # Post-archive actions
    post_archive:
      update_archive_index: true
      comment_on_issue: true
      comment_on_pr: true
      remove_from_local: true

  # Integration with other plugins
  integration:
    work_plugin: fractary-work
    file_plugin: fractary-file
    link_to_issue: true
    update_issue_on_create: true
    update_issue_on_archive: true
    github_link_format: dual

  # Template settings
  templates:
    default: spec-basic
    custom_template_dir: null

# ============================================================================
# Documentation Management Configuration
# Generate and manage project documentation
# ============================================================================
docs:
  schema_version: "1.1"

  # Lifecycle hooks
  hooks:
    pre_generate: null
    post_generate: null
    pre_validate: null
    post_validate: null
    pre_update: null
    post_update: null

  # Document type configurations
  doc_types:
    # Architecture Decision Records
    adr:
      enabled: true
      path: docs/architecture/ADR
      auto_number: true
      number_format: "%05d"
      generate_on_architectural_decision: true
      enforce_immutability: true

    # Architecture documentation
    architecture:
      enabled: true
      path: docs/architecture
      auto_update_index: true
      types: [overview, component, diagram]

    # User/developer guides
    guide:
      enabled: true
      path: docs/guides
      auto_update_index: true
      audiences: [developer, user, admin, contributor]

    # Schema documentation
    schema:
      enabled: true
      path: docs/schema
      dual_format: true
      auto_update_index: true
      generate_json: true
      optional_changelog: true

    # API documentation
    api:
      enabled: true
      path: docs/api
      dual_format: true
      auto_update_index: true
      generate_openapi: true
      http_methods: [GET, POST, PUT, PATCH, DELETE]

    # Standards and conventions
    standard:
      enabled: true
      path: docs/standards
      auto_update_index: true
      scopes: [plugin, repo, org, team]

    # Feature specifications
    spec:
      enabled: true
      path: docs/specs
      link_to_work_items: true

    # Operational runbooks
    runbook:
      enabled: true
      path: docs/operations/runbooks

    # Deployment documentation
    deployment:
      enabled: true
      path: docs/deployments

    # Design documents
    design:
      enabled: true
      path: docs/architecture/designs

  # Output directory mapping
  output_paths:
    documentation: docs
    adrs: docs/architecture/ADR
    architecture: docs/architecture
    designs: docs/architecture/designs
    guides: docs/guides
    schemas: docs/schema
    api_docs: docs/api
    standards: docs/standards
    runbooks: docs/operations/runbooks
    testing: docs/testing
    deployments: docs/deployments

  # Template settings
  templates:
    custom_template_dir: null
    use_project_templates: true

  # Frontmatter configuration
  frontmatter:
    always_include: true
    codex_sync: true
    default_fields:
      author: Claude Code
      generated: true

  # Validation rules
  validation:
    lint_on_generate: true
    check_links_on_generate: false
    custom_rules_script: null
    project_standards_doc: null

    # Required sections per document type
    required_sections:
      adr: [Status, Context, Decision, Consequences]
      architecture: [Overview, Components, Patterns]
      guide: [Purpose, Prerequisites, Steps]
      schema: [Overview, Schema Format, Fields, Validation Rules, Versioning]
      api: [Overview, Endpoints, Authentication, Examples, Error Codes]
      standard: [Purpose, Standards, Enforcement, Examples]
      design: [Overview, Architecture, Implementation]
      runbook: [Purpose, Prerequisites, Steps, Troubleshooting]
      test-report: [Summary, Test Cases, Results]
      deployment: [Overview, Infrastructure, Deployment Steps]

    # Valid status values per document type
    status_values:
      adr: [proposed, accepted, deprecated, superseded]
      architecture: [draft, review, approved, deprecated]
      guide: [draft, review, published, archived]
      schema: [draft, review, approved, deprecated]
      api: [draft, review, published, deprecated]
      standard: [draft, review, active, deprecated]

  # Documentation linking
  linking:
    auto_update_index: true
    check_broken_links: true
    generate_graph: true
# ============================================================================
# Codex Configuration
# Cross-project context management
# ============================================================================
codex:
  schema_version: "2.0"
  organization: fractary
  project: core
  dependencies: {}

